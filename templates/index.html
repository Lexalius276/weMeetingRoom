<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>weRoom — Agenda Salle de Réunion</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --ink: #1a1a2e;
    --paper: #f5f2ed;
    --accent: #c9a96e;
    --accent-dark: #a8813f;
    --accent-light: #f0e8d8;
    --muted: #8a8070;
    --card: #ffffff;
    --border: #e0d9ce;
    --danger: #c0392b;
    --success: #27ae60;
    --sidebar-w: 300px;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* HEADER */
  header {
    background: var(--ink);
    color: white;
    padding: 0 32px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(26,26,46,0.3);
  }

  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    letter-spacing: -0.3px;
  }

  .logo span { color: var(--accent); }

  .header-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .user-badge {
    font-size: 13px;
    color: rgba(255,255,255,0.6);
  }

  .user-badge strong { color: var(--accent); font-weight: 500; }

  .btn-logout {
    font-size: 12px;
    color: rgba(255,255,255,0.4);
    text-decoration: none;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 6px 12px;
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 2px;
    transition: all 0.2s;
  }

  .btn-logout:hover { color: white; border-color: rgba(255,255,255,0.4); }

  /* LAYOUT */
  .main {
    display: flex;
    flex: 1;
    gap: 0;
  }

  /* SIDEBAR */
  .sidebar {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--card);
    border-right: 1px solid var(--border);
    padding: 28px 24px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .sidebar-title {
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 500;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .form-group { display: flex; flex-direction: column; gap: 7px; }

  .form-group label {
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    font-weight: 500;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 2px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--ink);
    background: var(--paper);
    transition: border-color 0.2s;
    width: 100%;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--accent);
    background: white;
  }

  .form-group textarea { resize: vertical; min-height: 64px; }

  .btn-reserver {
    width: 100%;
    padding: 13px;
    background: var(--accent);
    color: var(--ink);
    border: none;
    border-radius: 2px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-reserver:hover { background: var(--accent-dark); color: white; }

  /* MESSAGE */
  .message {
    padding: 10px 14px;
    border-radius: 2px;
    font-size: 13px;
    display: none;
    line-height: 1.4;
  }

  .message.success { background: #eafaf1; color: var(--success); border-left: 3px solid var(--success); display: block; }
  .message.error { background: #fdf0ee; color: var(--danger); border-left: 3px solid var(--danger); display: block; }

  /* CONTENT */
  .content {
    flex: 1;
    padding: 28px 32px;
    overflow: auto;
  }

  /* NAV SEMAINE */
  .week-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }

  .week-nav h2 {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 400;
    color: var(--ink);
  }

  .week-nav .nav-btns { display: flex; gap: 8px; }

  .nav-btn {
    padding: 8px 16px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 2px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    color: var(--ink);
    transition: all 0.2s;
  }

  .nav-btn:hover { background: var(--ink); color: white; border-color: var(--ink); }
  .nav-btn.today { background: var(--accent-light); border-color: var(--accent); color: var(--accent-dark); }

  /* GRILLE CALENDRIER */
  .calendar-grid {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .cal-header {
    display: grid;
    grid-template-columns: 64px repeat(5, 1fr);
    border-bottom: 2px solid var(--ink);
  }

  .cal-header-time {
    background: var(--ink);
    padding: 12px 8px;
  }

  .cal-day-header {
    padding: 12px 16px;
    background: var(--ink);
    color: white;
    text-align: center;
    border-left: 1px solid rgba(255,255,255,0.1);
  }

  .cal-day-header .day-name {
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.5);
  }

  .cal-day-header .day-num {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    line-height: 1.1;
    color: white;
  }

  .cal-day-header.today .day-num {
    color: var(--accent);
  }

  .cal-body {
    display: grid;
    grid-template-columns: 64px repeat(5, 1fr);
    position: relative;
  }

  .time-col {
    border-right: 1px solid var(--border);
  }

  .time-slot {
    height: 48px;
    padding: 4px 8px;
    font-size: 11px;
    color: var(--muted);
    text-align: right;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
  }

  .day-col {
    border-left: 1px solid var(--border);
    position: relative;
  }

  .day-cell {
    height: 48px;
    border-bottom: 1px solid rgba(224,217,206,0.5);
    position: relative;
    cursor: pointer;
    transition: background 0.15s;
  }

  .day-cell:hover { background: var(--accent-light); }

  .day-cell.past { background: rgba(138,128,112,0.04); cursor: default; }
  .day-cell.past:hover { background: rgba(138,128,112,0.04); }

  /* RÉSERVATIONS */
  .reservation-block {
    position: absolute;
    left: 3px;
    right: 3px;
    background: var(--ink);
    border-left: 3px solid var(--accent);
    border-radius: 2px;
    padding: 4px 8px;
    z-index: 10;
    cursor: pointer;
    overflow: hidden;
    transition: opacity 0.2s;
    box-shadow: 0 2px 8px rgba(26,26,46,0.2);
  }

  .reservation-block:hover { opacity: 0.85; }

  .reservation-block.mine {
    background: var(--accent-dark);
    border-left-color: white;
  }

  .res-name {
    font-size: 11px;
    font-weight: 600;
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .res-objet {
    font-size: 10px;
    color: rgba(255,255,255,0.7);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(26,26,46,0.6);
    z-index: 200;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: white;
    border-radius: 2px;
    padding: 36px;
    max-width: 400px;
    width: 90%;
    position: relative;
    box-shadow: 0 20px 60px rgba(26,26,46,0.3);
    animation: modalIn 0.2s ease;
    border-top: 3px solid var(--accent);
  }

  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.95) translateY(-10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .modal h3 {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    margin-bottom: 6px;
  }

  .modal-meta {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .modal-detail { margin-bottom: 12px; }
  .modal-detail .lbl { font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
  .modal-detail .val { font-size: 15px; margin-top: 2px; }

  .modal-actions { display: flex; gap: 12px; margin-top: 24px; }

  .btn-annuler-res {
    padding: 10px 20px;
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 2px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .btn-annuler-res:hover { opacity: 0.85; }

  .btn-close-modal {
    padding: 10px 20px;
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 2px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-close-modal:hover { background: var(--paper); }

  /* LISTE MOBILE / SEMAINE */
  .next-reservations {
    margin-top: 24px;
  }

  .next-title {
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 12px;
    font-weight: 500;
  }

  .res-list-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    border-radius: 2px;
    padding: 12px 16px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: box-shadow 0.2s;
  }

  .res-list-item:hover { box-shadow: 0 2px 12px rgba(26,26,46,0.1); }

  .res-list-item.mine { border-left-color: var(--ink); }

  .res-info { flex: 1; }
  .res-info .ri-date { font-size: 12px; color: var(--muted); }
  .res-info .ri-name { font-weight: 600; font-size: 14px; }
  .res-info .ri-objet { font-size: 13px; color: var(--muted); }

  .ri-time {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    color: var(--accent-dark);
    white-space: nowrap;
    margin-left: 16px;
  }

  @media (max-width: 768px) {
    .sidebar { width: 100%; min-width: unset; border-right: none; border-bottom: 1px solid var(--border); }
    .main { flex-direction: column; }
    .calendar-grid { display: none; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">we<span>Room</span></div>
  <div class="header-right">
    <div class="user-badge">Connecté·e en tant que <strong>{{ current_user }}</strong></div>
    <a href="/logout" class="btn-logout">Déconnexion</a>
  </div>
</header>

<div class="main">
  <!-- SIDEBAR FORMULAIRE -->
  <div class="sidebar">
    <div class="sidebar-title">Nouvelle réservation</div>

    <div class="form-group">
      <label>Date</label>
      <input type="date" id="f-date" min="">
    </div>
    <div class="form-group">
      <label>Heure de début</label>
      <select id="f-debut"></select>
    </div>
    <div class="form-group">
      <label>Heure de fin</label>
      <select id="f-fin"></select>
    </div>
    <div class="form-group">
      <label>Objet de la réunion</label>
      <textarea id="f-objet" placeholder="Ex: Réunion client Dupont, Appel conférence…"></textarea>
    </div>

    <div id="msg" class="message"></div>

    <button class="btn-reserver" onclick="reserver()">Réserver la salle</button>
  </div>

  <!-- CONTENU PRINCIPAL -->
  <div class="content">
    <div class="week-nav">
      <h2 id="week-label">Semaine du …</h2>
      <div class="nav-btns">
        <button class="nav-btn" onclick="changeWeek(-1)">← Préc.</button>
        <button class="nav-btn today" onclick="goToday()">Aujourd'hui</button>
        <button class="nav-btn" onclick="changeWeek(1)">Suiv. →</button>
      </div>
    </div>

    <div class="calendar-grid">
      <div class="cal-header" id="cal-header"></div>
      <div class="cal-body" id="cal-body"></div>
    </div>

    <div class="next-reservations">
      <div class="next-title" id="list-title">Réservations de la semaine</div>
      <div id="res-list"></div>
    </div>
  </div>
</div>

<!-- MODAL DÉTAIL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3 id="m-objet">—</h3>
    <div class="modal-meta" id="m-meta">—</div>
    <div class="modal-detail">
      <div class="lbl">Réservé par</div>
      <div class="val" id="m-who">—</div>
    </div>
    <div class="modal-detail">
      <div class="lbl">Créneau</div>
      <div class="val" id="m-time">—</div>
    </div>
    <div class="modal-actions">
      <button class="btn-close-modal" onclick="closeModal()">Fermer</button>
      <button class="btn-annuler-res" id="m-annuler" style="display:none" onclick="annulerFromModal()">Annuler cette réservation</button>
    </div>
  </div>
</div>

<script>
const CURRENT_USER = "{{ current_user }}";
const HEURES = [];
for (let h = 7; h <= 20; h++) {
  HEURES.push(`${String(h).padStart(2,'0')}:00`);
  if (h < 20) HEURES.push(`${String(h).padStart(2,'0')}:30`);
}
const HEURE_DEBUT_GRID = 7;
const HEURE_FIN_GRID = 20;
const SLOTS_COUNT = (HEURE_FIN_GRID - HEURE_DEBUT_GRID) * 2;
const SLOT_HEIGHT = 48;

let currentMonday = getMonday(new Date());
let allReservations = [];
let modalResId = null;

// INIT
function init() {
  // Peupler les selects
  const debut = document.getElementById('f-debut');
  const fin = document.getElementById('f-fin');
  HEURES.forEach(h => {
    debut.innerHTML += `<option value="${h}">${h}</option>`;
    fin.innerHTML += `<option value="${h}">${h}</option>`;
  });
  debut.value = "09:00";
  fin.value = "10:00";

  // Date par défaut = aujourd'hui
  const today = new Date();
  const todayStr = formatDate(today);
  document.getElementById('f-date').value = todayStr;
  document.getElementById('f-date').min = todayStr;

  renderWeek();
}

function getMonday(d) {
  const dt = new Date(d);
  const day = dt.getDay();
  const diff = (day === 0) ? -6 : 1 - day;
  dt.setDate(dt.getDate() + diff);
  dt.setHours(0,0,0,0);
  return dt;
}

function formatDate(d) {
  return d.toISOString().split('T')[0];
}

function formatDateFR(d) {
  return d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
}

function changeWeek(dir) {
  currentMonday.setDate(currentMonday.getDate() + dir * 7);
  renderWeek();
}

function goToday() {
  currentMonday = getMonday(new Date());
  renderWeek();
}

function getWeekDates() {
  const days = [];
  for (let i = 0; i < 5; i++) {
    const d = new Date(currentMonday);
    d.setDate(d.getDate() + i);
    days.push(d);
  }
  return days;
}

async function renderWeek() {
  const days = getWeekDates();
  const dateDebut = formatDate(days[0]);
  const dateFin = formatDate(days[4]);
  const today = formatDate(new Date());

  // Label
  const opts = { day: 'numeric', month: 'long', year: 'numeric' };
  document.getElementById('week-label').textContent =
    `Semaine du ${days[0].toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })} au ${days[4].toLocaleDateString('fr-FR', opts)}`;

  // Charger réservations
  const res = await fetch(`/api/reservations?date_debut=${dateDebut}&date_fin=${dateFin}`);
  allReservations = await res.json();

  // Header
  const header = document.getElementById('cal-header');
  header.innerHTML = `<div class="cal-header-time"></div>`;
  days.forEach(d => {
    const ds = formatDate(d);
    const isToday = ds === today;
    const dayName = d.toLocaleDateString('fr-FR', { weekday: 'short' });
    header.innerHTML += `
      <div class="cal-day-header ${isToday ? 'today' : ''}">
        <div class="day-name">${dayName}</div>
        <div class="day-num">${d.getDate()}</div>
      </div>`;
  });

  // Corps
  const body = document.getElementById('cal-body');
  body.innerHTML = '';

  // Colonne heures
  const timeCol = document.createElement('div');
  timeCol.className = 'time-col';
  for (let i = 0; i < SLOTS_COUNT; i++) {
    const h = HEURE_DEBUT_GRID + Math.floor(i / 2);
    const m = (i % 2) * 30;
    const label = m === 0 ? `${String(h).padStart(2,'0')}:00` : '';
    timeCol.innerHTML += `<div class="time-slot">${label}</div>`;
  }
  body.appendChild(timeCol);

  // Colonnes jours
  days.forEach((d, di) => {
    const ds = formatDate(d);
    const isPast = ds < today;
    const col = document.createElement('div');
    col.className = 'day-col';
    col.style.position = 'relative';

    // Cellules
    for (let i = 0; i < SLOTS_COUNT; i++) {
      const h = HEURE_DEBUT_GRID + Math.floor(i / 2);
      const m = (i % 2) * 30;
      const slotTime = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      const cell = document.createElement('div');
      cell.className = `day-cell${isPast ? ' past' : ''}`;
      if (!isPast) {
        cell.onclick = () => quickFill(ds, slotTime);
      }
      col.appendChild(cell);
    }

    // Blocs réservation
    const dayRes = allReservations.filter(r => r.date === ds);
    dayRes.forEach(r => {
      const block = buildResBlock(r);
      col.appendChild(block);
    });

    body.appendChild(col);
  });

  // Liste
  renderList(days);
}

function timeToSlot(t) {
  const [h, m] = t.split(':').map(Number);
  return (h - HEURE_DEBUT_GRID) * 2 + (m / 30);
}

function buildResBlock(r) {
  const startSlot = timeToSlot(r.heure_debut);
  const endSlot = timeToSlot(r.heure_fin);
  const top = startSlot * SLOT_HEIGHT;
  const height = (endSlot - startSlot) * SLOT_HEIGHT;

  const block = document.createElement('div');
  block.className = `reservation-block${r.collaborateur === CURRENT_USER ? ' mine' : ''}`;
  block.style.top = `${top}px`;
  block.style.height = `${Math.max(height - 4, 20)}px`;
  block.innerHTML = `
    <div class="res-name">${r.collaborateur}</div>
    <div class="res-objet">${r.objet}</div>`;
  block.onclick = (e) => { e.stopPropagation(); openModal(r); };
  return block;
}

function renderList(days) {
  const list = document.getElementById('res-list');
  const daySet = new Set(days.map(d => formatDate(d)));
  const weekRes = allReservations
    .filter(r => daySet.has(r.date))
    .sort((a, b) => (a.date + a.heure_debut).localeCompare(b.date + b.heure_debut));

  if (weekRes.length === 0) {
    list.innerHTML = `<div style="color:var(--muted);font-size:14px;padding:16px 0;">Aucune réservation cette semaine.</div>`;
    return;
  }

  list.innerHTML = weekRes.map(r => {
    const d = new Date(r.date + 'T12:00:00');
    const dateStr = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
    const mine = r.collaborateur === CURRENT_USER;
    return `
      <div class="res-list-item ${mine ? 'mine' : ''}" onclick="openModal(${JSON.stringify(r).replace(/"/g, '&quot;')})">
        <div class="res-info">
          <div class="ri-date">${dateStr.charAt(0).toUpperCase() + dateStr.slice(1)}</div>
          <div class="ri-name">${r.collaborateur}</div>
          <div class="ri-objet">${r.objet}</div>
        </div>
        <div class="ri-time">${r.heure_debut}–${r.heure_fin}</div>
      </div>`;
  }).join('');
}

function quickFill(date, heure) {
  document.getElementById('f-date').value = date;
  document.getElementById('f-debut').value = heure;
  // Fin = +1h
  const [h, m] = heure.split(':').map(Number);
  const finH = h + 1;
  if (finH <= 20) {
    document.getElementById('f-fin').value = `${String(finH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }
  document.getElementById('f-objet').focus();
}

async function reserver() {
  const date = document.getElementById('f-date').value;
  const debut = document.getElementById('f-debut').value;
  const fin = document.getElementById('f-fin').value;
  const objet = document.getElementById('f-objet').value;

  showMsg('', '');

  const res = await fetch('/api/reserver', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ date, heure_debut: debut, heure_fin: fin, objet })
  });

  const data = await res.json();
  if (data.success) {
    showMsg('Salle réservée avec succès !', 'success');
    document.getElementById('f-objet').value = '';
    renderWeek();
    // Aller à la semaine de la réservation
    const resDate = new Date(date + 'T12:00:00');
    currentMonday = getMonday(resDate);
    renderWeek();
  } else {
    showMsg(data.error || 'Erreur inconnue', 'error');
  }
}

function showMsg(text, type) {
  const el = document.getElementById('msg');
  el.textContent = text;
  el.className = `message ${type}`;
}

// MODAL
function openModal(r) {
  modalResId = r.id;
  const d = new Date(r.date + 'T12:00:00');
  const dateStr = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

  document.getElementById('m-objet').textContent = r.objet;
  document.getElementById('m-meta').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
  document.getElementById('m-who').textContent = r.collaborateur;
  document.getElementById('m-time').textContent = `${r.heure_debut} – ${r.heure_fin}`;

  const btnAnnuler = document.getElementById('m-annuler');
  btnAnnuler.style.display = r.collaborateur === CURRENT_USER ? 'block' : 'none';

  document.getElementById('modal').classList.add('active');
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
  modalResId = null;
}

async function annulerFromModal() {
  if (!modalResId) return;
  if (!confirm('Confirmer l\'annulation de cette réservation ?')) return;

  const res = await fetch(`/api/annuler/${modalResId}`, { method: 'DELETE' });
  const data = await res.json();
  if (data.success) {
    closeModal();
    renderWeek();
  } else {
    alert(data.error || 'Erreur lors de l\'annulation');
  }
}

document.getElementById('modal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('modal')) closeModal();
});

init();
</script>
</body>
</html>
